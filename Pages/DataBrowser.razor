@page "/data/{TableName}"
@using BlazorDataDev.Services
@inject IDynamicDbService DynamicDb

<h3>Data Browser: @TableName</h3>

@if (loading)
{
    <p><em>Loading data...</em></p>
}
else if (rows == null || !rows.Any())
{
    <div class="alert alert-info">No data found in table @TableName</div>
}
else
{
    <div class="mb-3">
        <strong>@totalRows</strong> total rows | Showing @rows.Count rows
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    @foreach (var column in columns)
                    {
                        <th>
                            @column.Name
                            <br/>
                            <small class="text-muted">@column.Type</small>
                        </th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var row in rows)
                {
                    <tr>
                        @foreach (var column in columns)
                        {
                            <td>
                                @if (row.IsNull(column.Name))
                                {
                                    <span class="text-muted">NULL</span>
                                }
                                else
                                {
                                    @row.GetFormatted(column.Name)
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <h5>Example: Type-Safe Access</h5>
        <div class="card">
            <div class="card-body">
                <pre><code>@exampleCode</code></pre>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string TableName { get; set; } = "";

    private List<DynamicRow>? rows;
    private List<ColumnInfo> columns = new();
    private int totalRows = 0;
    private bool loading = true;
    private string exampleCode = "";

    protected override async Task OnParametersSetAsync()
    {
        loading = true;
        
        try
        {
            // Get column metadata
            columns = await DynamicDb.GetColumnsAsync(TableName);
            
            // Get data rows (returns DynamicRow objects)
            rows = await DynamicDb.GetDataAsync(TableName, limit: 50);
            
            // Get total count
            totalRows = await DynamicDb.GetRowCountAsync(TableName);

            // Generate example code showing how to use DynamicRow
            if (rows.Any())
            {
                var firstRow = rows.First();
                var examples = new List<string>();
                
                examples.Add("// Example: Type-safe access to row data");
                examples.Add($"var row = rows.First();");
                examples.Add("");
                
                foreach (var column in columns.Take(3))
                {
                    var csharpType = MapPostgresToCSharp(column.Type);
                    examples.Add($"// Get {column.Name} as {csharpType}");
                    examples.Add($"var {column.Name} = row.Get<{csharpType}>(\"{column.Name}\");");
                    examples.Add($"// Value: {firstRow.GetFormatted(column.Name)}");
                    examples.Add("");
                }
                
                examples.Add("// Check for NULL");
                examples.Add($"if (row.IsNull(\"{columns.First().Name}\"))");
                examples.Add("    Console.WriteLine(\"Value is NULL\");");
                examples.Add("");
                
                examples.Add("// Get formatted string");
                examples.Add($"var formatted = row.GetFormatted(\"{columns.First().Name}\");");
                examples.Add("");
                
                examples.Add("// Quick access with indexer");
                examples.Add($"var value = row[\"{columns.First().Name}\"];");
                
                exampleCode = string.Join("\n", examples);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
            rows = new List<DynamicRow>();
        }
        finally
        {
            loading = false;
        }
    }

    private string MapPostgresToCSharp(string pgType)
    {
        return pgType.ToLower() switch
        {
            "varchar" or "text" or "character varying" => "string",
            "int4" or "integer" => "int",
            "int8" or "bigint" => "long",
            "float8" or "double precision" => "double",
            "float4" or "real" => "float",
            "bool" or "boolean" => "bool",
            "timestamp" or "timestamp without time zone" => "DateTime",
            "date" => "DateTime",
            "uuid" => "Guid",
            "numeric" or "decimal" => "decimal",
            _ => "object"
        };
    }
}

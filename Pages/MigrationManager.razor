@page "/migrations"
@using System.Text
@using System.Text.Json
@inject IJSRuntime JSRuntime

<PageTitle> Blazor DataDev- Migration Manager</PageTitle>

<style>
    .diff-added { background-color: #d4edda; color: #155724; }
    .diff-removed { background-color: #f8d7da; color: #721c24; }
    .diff-modified { background-color: #fff3cd; color: #856404; }
    .snapshot-card { cursor: pointer; transition: all 0.2s; }
    .snapshot-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
</style>

<h2>üöÄ Database Migration Manager</h2>

<div class="alert alert-info">
    <strong>Migration Workflow:</strong> Track schema changes, compare versions, and generate deployment scripts for moving changes between database servers.
</div>

<!-- Tab Navigation -->
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link @(activeTab == "snapshots" ? "active" : "")" @onclick='() => activeTab = "snapshots"' href="#">
            üì∏ Snapshots
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(activeTab == "compare" ? "active" : "")" @onclick='() => activeTab = "compare"' href="#">
            üîç Compare & Diff
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(activeTab == "migration" ? "active" : "")" @onclick='() => activeTab = "migration"' href="#">
            üìù Migration Scripts
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(activeTab == "changelog" ? "active" : "")" @onclick='() => activeTab = "changelog"' href="#">
            üìã Change Log
        </a>
    </li>
</ul>

@if (activeTab == "snapshots")
{
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Create Snapshot</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Load DDL File</label>
                        <InputFile OnChange="HandleDDLUpload" class="form-control" accept=".txt,.sql" />
                    </div>
                    @if (!string.IsNullOrEmpty(currentDdl))
                    {
                        <div class="mb-3">
                            <label class="form-label">Snapshot Name</label>
                            <input type="text" class="form-control" @bind="snapshotName" placeholder="e.g., 'Dev Server - Initial State'" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description (optional)</label>
                            <textarea class="form-control" @bind="snapshotDescription" rows="2" placeholder="Describe what this snapshot represents..."></textarea>
                        </div>
                        <button class="btn btn-primary" @onclick="CreateSnapshot">
                            üì∏ Create Snapshot
                        </button>
                        <div class="mt-2 text-success">
                            ‚úì DDL loaded (@currentTableCount tables found)
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Saved Snapshots (@snapshots.Count)</h5>
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    @if (!snapshots.Any())
                    {
                        <p class="text-muted">No snapshots yet. Create your first snapshot to start tracking changes.</p>
                    }
                    else
                    {
                        @foreach (var snapshot in snapshots.OrderByDescending(s => s.Timestamp))
                        {
                            <div class="card snapshot-card mb-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">@snapshot.Name</h6>
                                            <small class="text-muted">@snapshot.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</small>
                                            <div class="mt-1">
                                                <span class="badge bg-secondary">@snapshot.TableCount tables</span>
                                                <span class="badge bg-info">@snapshot.TotalColumns columns</span>
                                            </div>
                                            @if (!string.IsNullOrEmpty(snapshot.Description))
                                            {
                                                <p class="mt-2 mb-0"><small>@snapshot.Description</small></p>
                                            }
                                        </div>
                                        <div class="btn-group-vertical btn-group-sm">
                                            <button class="btn btn-outline-primary" @onclick="() => LoadSnapshot(snapshot)">Load</button>
                                            <button class="btn btn-outline-success" @onclick="() => ExportSnapshot(snapshot)">Export</button>
                                            <button class="btn btn-outline-danger" @onclick="() => DeleteSnapshot(snapshot)">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
}
else if (activeTab == "compare")
{
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Select Snapshots to Compare</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Baseline (Before)</label>
                        <select class="form-select" @bind="compareBaselineId">
                            <option value="">-- Select baseline snapshot --</option>
                            @foreach (var snapshot in snapshots.OrderByDescending(s => s.Timestamp))
                            {
                                <option value="@snapshot.Id">@snapshot.Name (@snapshot.Timestamp.ToString("MM/dd HH:mm"))</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target (After)</label>
                        <select class="form-select" @bind="compareTargetId">
                            <option value="">-- Select target snapshot --</option>
                            @foreach (var snapshot in snapshots.OrderByDescending(s => s.Timestamp))
                            {
                                <option value="@snapshot.Id">@snapshot.Name (@snapshot.Timestamp.ToString("MM/dd HH:mm"))</option>
                            }
                        </select>
                    </div>
                    <button class="btn btn-primary" @onclick="CompareSnapshots" disabled="@(string.IsNullOrEmpty(compareBaselineId) || string.IsNullOrEmpty(compareTargetId))">
                        üîç Compare Schemas
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            @if (comparisonResult != null)
            {
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Comparison Summary</h5>
                        <button class="btn btn-sm btn-success" @onclick="ExportDiff">
                            üì§ Export Diff
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <span class="badge bg-success">@comparisonResult.AddedColumns.Count Added</span>
                            <span class="badge bg-danger">@comparisonResult.RemovedColumns.Count Removed</span>
                            <span class="badge bg-warning">@comparisonResult.ModifiedColumns.Count Modified</span>
                        </div>
                        
                        @if (comparisonResult.AddedColumns.Any())
                        {
                            <h6 class="text-success">‚úÖ Added Columns:</h6>
                            <ul class="list-unstyled">
                                @foreach (var change in comparisonResult.AddedColumns)
                                {
                                    <li class="diff-added p-1 mb-1"><code>@change</code></li>
                                }
                            </ul>
                        }
                        
                        @if (comparisonResult.RemovedColumns.Any())
                        {
                            <h6 class="text-danger">‚ùå Removed Columns:</h6>
                            <ul class="list-unstyled">
                                @foreach (var change in comparisonResult.RemovedColumns)
                                {
                                    <li class="diff-removed p-1 mb-1"><code>@change</code></li>
                                }
                            </ul>
                        }
                        
                        @if (comparisonResult.ModifiedColumns.Any())
                        {
                            <h6 class="text-warning">‚ö†Ô∏è Modified Columns:</h6>
                            <ul class="list-unstyled">
                                @foreach (var change in comparisonResult.ModifiedColumns)
                                {
                                    <li class="diff-modified p-1 mb-1"><code>@change</code></li>
                                }
                            </ul>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}
else if (activeTab == "migration")
{
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Generate Migration Script</h5>
            <button class="btn btn-sm btn-success" @onclick="DownloadMigrationScript" disabled="@(string.IsNullOrEmpty(migrationScript))">
                üì• Download Script
            </button>
        </div>
        <div class="card-body">
            @if (comparisonResult != null)
            {
                <div class="mb-3">
                    <label class="form-label">Migration Version</label>
                    <input type="text" class="form-control" @bind="migrationVersion" placeholder="e.g., v1.0.0 or 001" />
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" @bind="includeRollback" id="includeRollback" />
                    <label class="form-check-label" for="includeRollback">
                        Include rollback statements
                    </label>
                </div>
                <button class="btn btn-primary" @onclick="GenerateMigrationScript">
                    üìù Generate Migration Script
                </button>
                
                @if (!string.IsNullOrEmpty(migrationScript))
                {
                    <div class="mt-3">
                        <label class="form-label">Generated Migration Script:</label>
                        <pre style="max-height: 500px; overflow-y: auto; background-color: #f8f9fa; padding: 1rem; border-radius: 0.25rem;">@migrationScript</pre>
                    </div>
                }
            }
            else
            {
                <div class="alert alert-warning">
                    Please compare two snapshots first in the "Compare & Diff" tab to generate a migration script.
                </div>
            }
        </div>
    </div>
}
else if (activeTab == "changelog")
{
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Change Log</h5>
            <button class="btn btn-sm btn-success" @onclick="ExportChangeLog" disabled="@(!changeLog.Any())">
                üì§ Export Log
            </button>
        </div>
        <div class="card-body">
            @if (!changeLog.Any())
            {
                <p class="text-muted">No changes recorded yet. Changes will be logged as you create snapshots and comparisons.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entry in changeLog.OrderByDescending(e => e.Timestamp))
                            {
                                <tr>
                                    <td>@entry.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                    <td><span class="badge bg-primary">@entry.Action</span></td>
                                    <td>@entry.Details</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
}

@code {
    private string activeTab = "snapshots";
    private string currentDdl = "";
    private int currentTableCount = 0;
    private string snapshotName = "";
    private string snapshotDescription = "";
    private List<SchemaSnapshot> snapshots = new();
    private string compareBaselineId = "";
    private string compareTargetId = "";
    private ComparisonResult? comparisonResult;
    private string migrationScript = "";
    private string migrationVersion = "001";
    private bool includeRollback = true;
    private List<ChangeLogEntry> changeLog = new();

    private class SchemaSnapshot
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public DateTime Timestamp { get; set; } = DateTime.Now;
        public string DdlContent { get; set; } = "";
        public int TableCount { get; set; }
        public int TotalColumns { get; set; }
        public Dictionary<string, List<ColumnInfo>> Tables { get; set; } = new();
    }

    private class ColumnInfo
    {
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";
        public bool Nullable { get; set; }
    }

    private class ComparisonResult
    {
        public List<string> AddedColumns { get; set; } = new();
        public List<string> RemovedColumns { get; set; } = new();
        public List<string> ModifiedColumns { get; set; } = new();
    }

    private class ChangeLogEntry
    {
        public DateTime Timestamp { get; set; } = DateTime.Now;
        public string Action { get; set; } = "";
        public string Details { get; set; } = "";
    }

    private async Task HandleDDLUpload(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var reader = new StreamReader(stream);
            currentDdl = await reader.ReadToEndAsync();
            
            currentTableCount = ParseTableCount(currentDdl);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading DDL: {ex.Message}");
        }
    }

    private int ParseTableCount(string ddl)
    {
        return System.Text.RegularExpressions.Regex.Matches(ddl, @"CREATE TABLE", System.Text.RegularExpressions.RegexOptions.IgnoreCase).Count;
    }

    private void CreateSnapshot()
    {
        if (string.IsNullOrEmpty(currentDdl) || string.IsNullOrEmpty(snapshotName))
            return;

        var tables = ParseDDLToTables(currentDdl);
        var totalColumns = tables.Values.Sum(cols => cols.Count);

        var snapshot = new SchemaSnapshot
        {
            Name = snapshotName,
            Description = snapshotDescription,
            DdlContent = currentDdl,
            TableCount = tables.Count,
            TotalColumns = totalColumns,
            Tables = tables
        };

        snapshots.Add(snapshot);
        
        changeLog.Add(new ChangeLogEntry
        {
            Action = "Snapshot Created",
            Details = $"{snapshotName} - {tables.Count} tables, {totalColumns} columns"
        });

        snapshotName = "";
        snapshotDescription = "";
    }

    private Dictionary<string, List<ColumnInfo>> ParseDDLToTables(string ddl)
    {
        var result = new Dictionary<string, List<ColumnInfo>>();
        var lines = ddl.Split('\n');
        string? currentTable = null;
        List<ColumnInfo>? currentColumns = null;
        bool inTableDef = false;

        foreach (var line in lines)
        {
            var trimmed = line.Trim();

            if (trimmed.StartsWith("CREATE TABLE", StringComparison.OrdinalIgnoreCase))
            {
                var parts = trimmed.Split(new[] { ' ', '(' }, StringSplitOptions.RemoveEmptyEntries);
                if (parts.Length >= 3)
                {
                    currentTable = parts[2].Replace("dbo.", "").Replace(";", "");
                    currentColumns = new List<ColumnInfo>();
                    result[currentTable] = currentColumns;
                    inTableDef = true;
                }
            }
            else if (inTableDef && !trimmed.StartsWith("CONSTRAINT") && !trimmed.StartsWith(");") && !trimmed.StartsWith("--"))
            {
                if (trimmed.Contains(" ") && !string.IsNullOrWhiteSpace(trimmed))
                {
                    var parts = trimmed.Split(new[] { ' ', '\t' }, StringSplitOptions.RemoveEmptyEntries);
                    if (parts.Length >= 2 && !parts[0].StartsWith("--"))
                    {
                        var colName = parts[0].Trim('"', ',');
                        var colType = parts[1].Trim(',');
                        var nullable = !trimmed.Contains("NOT NULL", StringComparison.OrdinalIgnoreCase);

                        currentColumns?.Add(new ColumnInfo
                        {
                            Name = colName,
                            Type = colType,
                            Nullable = nullable
                        });
                    }
                }
            }
            else if (trimmed.StartsWith(");"))
            {
                inTableDef = false;
                currentTable = null;
                currentColumns = null;
            }
        }

        return result;
    }

    private void LoadSnapshot(SchemaSnapshot snapshot)
    {
        currentDdl = snapshot.DdlContent;
        currentTableCount = snapshot.TableCount;
        snapshotName = $"{snapshot.Name} (Copy)";
    }

    private async Task ExportSnapshot(SchemaSnapshot snapshot)
    {
        var fileName = $"snapshot_{snapshot.Name.Replace(" ", "_")}_{snapshot.Timestamp:yyyyMMdd_HHmmss}.sql";
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, snapshot.DdlContent);
    }

    private void DeleteSnapshot(SchemaSnapshot snapshot)
    {
        snapshots.Remove(snapshot);
        changeLog.Add(new ChangeLogEntry
        {
            Action = "Snapshot Deleted",
            Details = snapshot.Name
        });
    }

    private void CompareSnapshots()
    {
        var baseline = snapshots.FirstOrDefault(s => s.Id == compareBaselineId);
        var target = snapshots.FirstOrDefault(s => s.Id == compareTargetId);

        if (baseline == null || target == null)
            return;

        comparisonResult = new ComparisonResult();

        foreach (var tableName in target.Tables.Keys.Union(baseline.Tables.Keys))
        {
            var baselineCols = baseline.Tables.ContainsKey(tableName) ? baseline.Tables[tableName] : new List<ColumnInfo>();
            var targetCols = target.Tables.ContainsKey(tableName) ? target.Tables[tableName] : new List<ColumnInfo>();

            foreach (var col in targetCols)
            {
                var baselineCol = baselineCols.FirstOrDefault(c => c.Name == col.Name);
                if (baselineCol == null)
                {
                    comparisonResult.AddedColumns.Add($"{tableName}.{col.Name} ({col.Type})");
                }
                else if (baselineCol.Type != col.Type || baselineCol.Nullable != col.Nullable)
                {
                    comparisonResult.ModifiedColumns.Add($"{tableName}.{col.Name}: {baselineCol.Type} ‚Üí {col.Type}");
                }
            }

            foreach (var col in baselineCols)
            {
                if (!targetCols.Any(c => c.Name == col.Name))
                {
                    comparisonResult.RemovedColumns.Add($"{tableName}.{col.Name} ({col.Type})");
                }
            }
        }

        changeLog.Add(new ChangeLogEntry
        {
            Action = "Comparison",
            Details = $"{baseline.Name} vs {target.Name}: {comparisonResult.AddedColumns.Count} added, {comparisonResult.RemovedColumns.Count} removed, {comparisonResult.ModifiedColumns.Count} modified"
        });
    }

    private void GenerateMigrationScript()
    {
        if (comparisonResult == null)
            return;

        var script = new StringBuilder();
        script.AppendLine($"-- Migration Script: v{migrationVersion}");
        script.AppendLine($"-- Generated: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
        script.AppendLine($"-- Changes: {comparisonResult.AddedColumns.Count} added, {comparisonResult.RemovedColumns.Count} removed, {comparisonResult.ModifiedColumns.Count} modified");
        script.AppendLine();
        script.AppendLine("-- ========================================");
        script.AppendLine("-- FORWARD MIGRATION");
        script.AppendLine("-- ========================================");
        script.AppendLine();

        foreach (var added in comparisonResult.AddedColumns)
        {
            var parts = added.Split('.');
            var tableName = parts[0];
            var columnDef = parts[1];
            script.AppendLine($"ALTER TABLE dbo.{tableName} ADD COLUMN {columnDef};");
        }

        foreach (var removed in comparisonResult.RemovedColumns)
        {
            var parts = removed.Split('.');
            var tableName = parts[0];
            var columnName = parts[1].Split(' ')[0];
            script.AppendLine($"-- ALTER TABLE dbo.{tableName} DROP COLUMN {columnName};  -- COMMENTED: Review before dropping");
        }

        if (includeRollback)
        {
            script.AppendLine();
            script.AppendLine("-- ========================================");
            script.AppendLine("-- ROLLBACK MIGRATION");
            script.AppendLine("-- ========================================");
            script.AppendLine();

            foreach (var added in comparisonResult.AddedColumns)
            {
                var parts = added.Split('.');
                var tableName = parts[0];
                var columnName = parts[1].Split(' ')[0];
                script.AppendLine($"-- ALTER TABLE dbo.{tableName} DROP COLUMN {columnName};");
            }

            foreach (var removed in comparisonResult.RemovedColumns)
            {
                var parts = removed.Split('.');
                var tableName = parts[0];
                var columnDef = parts[1];
                script.AppendLine($"-- ALTER TABLE dbo.{tableName} ADD COLUMN {columnDef};");
            }
        }

        migrationScript = script.ToString();
        
        changeLog.Add(new ChangeLogEntry
        {
            Action = "Migration Generated",
            Details = $"v{migrationVersion} - {comparisonResult.AddedColumns.Count + comparisonResult.RemovedColumns.Count} changes"
        });
    }

    private async Task DownloadMigrationScript()
    {
        var fileName = $"migration_v{migrationVersion}_{DateTime.Now:yyyyMMdd_HHmmss}.sql";
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, migrationScript);
    }

    private async Task ExportDiff()
    {
        if (comparisonResult == null)
            return;

        var diff = new StringBuilder();
        diff.AppendLine($"Schema Comparison Report");
        diff.AppendLine($"Generated: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
        diff.AppendLine();
        diff.AppendLine($"Added Columns: {comparisonResult.AddedColumns.Count}");
        foreach (var item in comparisonResult.AddedColumns)
            diff.AppendLine($"  + {item}");
        diff.AppendLine();
        diff.AppendLine($"Removed Columns: {comparisonResult.RemovedColumns.Count}");
        foreach (var item in comparisonResult.RemovedColumns)
            diff.AppendLine($"  - {item}");
        diff.AppendLine();
        diff.AppendLine($"Modified Columns: {comparisonResult.ModifiedColumns.Count}");
        foreach (var item in comparisonResult.ModifiedColumns)
            diff.AppendLine($"  ~ {item}");

        var fileName = $"schema_diff_{DateTime.Now:yyyyMMdd_HHmmss}.txt";
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, diff.ToString());
    }

    private async Task ExportChangeLog()
    {
        var log = new StringBuilder();
        log.AppendLine("Database Change Log");
        log.AppendLine($"Exported: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
        log.AppendLine();
        
        foreach (var entry in changeLog.OrderBy(e => e.Timestamp))
        {
            log.AppendLine($"[{entry.Timestamp:yyyy-MM-dd HH:mm:ss}] {entry.Action}: {entry.Details}");
        }

        var fileName = $"changelog_{DateTime.Now:yyyyMMdd_HHmmss}.txt";
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, log.ToString());
    }
}
